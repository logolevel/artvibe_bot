require('dotenv').config();
const { Telegraf, Markup } = require('telegraf');
const express = require('express');

// --- –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è ---
const {
    BOT_TOKEN,
    PORT,
    WEBHOOK_URL,
    INVITE_LINK,
    EXPRESS_PDF_FILE_ID,
    AUTHOR_PDF_FILE_ID,
    ADMIN_ID_RADMILA,
    ADMIN_ID_DANYLO,
    ADMIN_ID_ANASTASIA,
    ADMIN_NAME_RADMILA,
    ADMIN_NAME_DANYLO,
    ADMIN_NAME_ANASTASIA,
    CARD_NUMBER_RUB,
    IBAN_EUR,
    CARD_NUMBER_UAH,
} = process.env;

if (!BOT_TOKEN || !PORT || !WEBHOOK_URL) {
    throw new Error("–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–∞–¥–∞—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è: BOT_TOKEN, PORT –∏ WEBHOOK_URL");
}

// --- –¢–µ–∫—Å—Ç—ã –Ω–∞ –∫–Ω–æ–ø–∫–∞—Ö ---
const COPY_BUTTON_RUB = "–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–º–µ—Ä üëá";
const COPY_BUTTON_EUR = "–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å IBAN üëá";
const COPY_BUTTON_UAH = "–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–º–µ—Ä üëá";


// --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞ –∏ Express ---
const bot = new Telegraf(BOT_TOKEN);
const app = express();

// --- –í—Ä–µ–º–µ–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ ---
const paymentExpectations = new Map();

// --- –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã ---
const mainMenu = Markup.keyboard([
    ['–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π —É—Ä–æ–∫'],
    ['–≠–∫—Å–ø—Ä–µ—Å—Å –∫—É—Ä—Å', '–ê–≤—Ç–æ—Ä—Å–∫–∏–π –∫—É—Ä—Å'],
]).resize();

const freeLessonMenu = Markup.inlineKeyboard([
    Markup.button.url('–ü–æ–ª—É—á–∏—Ç—å —É—Ä–æ–∫', INVITE_LINK || 'https://t.me/'),
]);

const expressCourseMenu = Markup.inlineKeyboard([
    [Markup.button.callback('–£–∑–Ω–∞—Ç—å –±–æ–ª—å—à–µ', 'express_learn_more')],
    [Markup.button.callback('–ü—Ä–∏–æ–±—Ä–µ—Å—Ç–∏ —ç–∫—Å–ø—Ä–µ—Å—Å –∫—É—Ä—Å', 'express_buy')],
]);

const authorCourseMenu = Markup.inlineKeyboard([
    [Markup.button.callback('–£–∑–Ω–∞—Ç—å –±–æ–ª—å—à–µ', 'author_learn_more')],
    [Markup.button.callback('–ü—Ä–∏–æ–±—Ä–µ—Å—Ç–∏ –∞–≤—Ç–æ—Ä—Å–∫–∏–π –∫—É—Ä—Å', 'author_buy')],
]);

const paymentMenu = (coursePrefix) => Markup.inlineKeyboard([
    [Markup.button.callback('–û–ø–ª–∞—Ç–∞ –≤ —Ä—É–±–ª—è—Ö', `${coursePrefix}_pay_rub`)],
    [Markup.button.callback('–û–ø–ª–∞—Ç–∞ –≤ –µ–≤—Ä–æ', `${coursePrefix}_pay_eur`)],
    [Markup.button.callback('–û–ø–ª–∞—Ç–∞ –≤ –≥—Ä–∏–≤–Ω–∞—Ö', `${coursePrefix}_pay_uah`)],
]);

// --- –õ–æ–≥–∏–∫–∞ –±–æ—Ç–∞ ---

bot.start(async (ctx) => {
    const welcomeMessage = `
üëã **–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!**

–í—ã–±–µ—Ä–∏—Ç–µ –∏–Ω—Ç–µ—Ä–µ—Å—É—é—â–∏–π –≤–∞—Å —Ä–∞–∑–¥–µ–ª –≤ –º–µ–Ω—é –Ω–∏–∂–µ. üëá
    `;
    await ctx.replyWithMarkdown(welcomeMessage, mainMenu);
});

bot.on('channel_post', async (ctx) => {
    if (ctx.channelPost && ctx.channelPost.document && ctx.channelPost.document.mime_type === 'application/pdf') {
        const fileId = ctx.channelPost.document.file_id;
        const chatId = ctx.channelPost.chat.id;
        await bot.telegram.sendMessage(chatId, `PDF –ø–æ–ª—É—á–µ–Ω (–∏–∑ –∫–∞–Ω–∞–ª–∞). –í–æ—Ç –µ–≥–æ file_id:`);
        await bot.telegram.sendMessage(chatId, `<code>${fileId}</code>`, { parse_mode: 'HTML' });
    }
});

bot.hears('–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π —É—Ä–æ–∫', (ctx) => {
    const message = `
‚ú® **–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π —É—Ä–æ–∫ —É–∂–µ –∂–¥–µ—Ç –≤–∞—Å!**

–≠—Ç–æ –æ—Ç–ª–∏—á–Ω–∞—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–æ–∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è —Å –Ω–∞—à–∏–º –ø–æ–¥—Ö–æ–¥–æ–º –∫ –æ–±—É—á–µ–Ω–∏—é. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –º–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø.
    `;
    ctx.replyWithMarkdown(message, freeLessonMenu);
});

bot.hears('–≠–∫—Å–ø—Ä–µ—Å—Å –∫—É—Ä—Å', (ctx) => {
    const message = `
üöÄ **–≠–∫—Å–ø—Ä–µ—Å—Å –∫—É—Ä—Å**

–ò–¥–µ–∞–ª—å–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç –¥–ª—è —Ç–µ—Ö, –∫—Ç–æ —Ö–æ—á–µ—Ç –±—ã—Å—Ç—Ä–æ –ø–æ–≥—Ä—É–∑–∏—Ç—å—Å—è –≤ —Ç–µ–º—É –∏ –ø–æ–ª—É—á–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç.
    `;
    ctx.replyWithMarkdown(message, expressCourseMenu);
});

bot.hears('–ê–≤—Ç–æ—Ä—Å–∫–∏–π –∫—É—Ä—Å', (ctx) => {
    const message = `
üéì **–ê–≤—Ç–æ—Ä—Å–∫–∏–π –∫—É—Ä—Å**

–ü–æ–ª–Ω–æ–µ –∏ –≥–ª—É–±–æ–∫–æ–µ –ø–æ–≥—Ä—É–∂–µ–Ω–∏–µ –≤ –ø—Ä–µ–¥–º–µ—Ç —Å –ª–∏—á–Ω–æ–π –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –∞–≤—Ç–æ—Ä–∞. –ú–∞–∫—Å–∏–º—É–º –ø—Ä–∞–∫—Ç–∏–∫–∏ –∏ –∑–Ω–∞–Ω–∏–π.
    `;
    ctx.replyWithMarkdown(message, authorCourseMenu);
});

bot.action('express_learn_more', (ctx) => {
    if (!EXPRESS_PDF_FILE_ID) return ctx.reply('–§–∞–π–ª —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –∫—É—Ä—Å–µ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.');
    ctx.replyWithDocument(EXPRESS_PDF_FILE_ID, { caption: '–ü–æ–¥—Ä–æ–±–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞ —ç–∫—Å–ø—Ä–µ—Å—Å –∫—É—Ä—Å–∞.' });
    ctx.answerCbQuery();
});

bot.action('author_learn_more', (ctx) => {
    if (!AUTHOR_PDF_FILE_ID) return ctx.reply('–§–∞–π–ª —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –∫—É—Ä—Å–µ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.');
    ctx.replyWithDocument(AUTHOR_PDF_FILE_ID, { caption: '–ü–æ–¥—Ä–æ–±–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞ –∞–≤—Ç–æ—Ä—Å–∫–æ–≥–æ –∫—É—Ä—Å–∞.' });
    ctx.answerCbQuery();
});

bot.action(['express_buy', 'author_buy'], (ctx) => {
    const coursePrefix = ctx.match[0].split('_')[0];
    ctx.reply('–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞–ª—é—Ç—É –¥–ª—è –æ–ø–ª–∞—Ç—ã:', paymentMenu(coursePrefix));
    ctx.answerCbQuery();
});

// --- –õ–æ–≥–∏–∫–∞ –æ–ø–ª–∞—Ç—ã ---

const handlePayment = async (ctx, coursePrefix, requisites, copyText, adminId, adminName) => {
    const userId = ctx.from.id;
    const username = ctx.from.username;
    const currency = copyText === COPY_BUTTON_RUB ? 'rub' : (copyText === COPY_BUTTON_EUR ? 'eur' : 'uah');

    // –°—Ä–∞–∑—É –æ—Ç–≤–µ—á–∞–µ–º –Ω–∞ –∫–æ–ª–±—ç–∫, —á—Ç–æ–±—ã —É–±—Ä–∞—Ç—å —á–∞—Å–∏–∫–∏ –Ω–∞ –∫–Ω–æ–ø–∫–µ
    ctx.answerCbQuery();

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ù–û–í–û–ï —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Ä–µ–∫–≤–∏–∑–∏—Ç–∞–º–∏, –≤–º–µ—Å—Ç–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Ç–∞—Ä–æ–≥–æ
    await ctx.reply(
        requisites,
        Markup.inlineKeyboard([Markup.button.callback(copyText, `copy_${currency}`)])
    );

    setTimeout(() => {
        if (username) {
            ctx.reply("–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–∫—Ä–∏–Ω—à–æ—Ç –æ–ø–ª–∞—Ç—ã –≤ —ç—Ç–æ—Ç —á–∞—Ç, –ø—Ä–æ—Å—Ç–æ –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç–µ —Ñ–æ—Ç–æ.");
            paymentExpectations.set(userId, { adminId, course: coursePrefix });
        } else {
            ctx.reply(`–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –Ω–∞–º ${adminName} —Å–∫—Ä–∏–Ω—à–æ—Ç –æ–ø–ª–∞—Ç—ã –≤ –ª–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è, –∏ –º—ã —Å—Ä–∞–∑—É –∂–µ –æ—Ç–ø—Ä–∞–≤–∏–º –í–∞–º —Å—Å—ã–ª–∫—É –Ω–∞ –∫—É—Ä—Å.`);
        }
    }, 60 * 1000);
};

// --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –æ–ø–ª–∞—Ç—ã ---
// –¢–µ–ø–µ—Ä—å –º—ã —Ñ–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –ø—Ä—è–º–æ –∑–¥–µ—Å—å –∏ –ø–µ—Ä–µ–¥–∞–µ–º –µ–≥–æ –≤ handlePayment

const createRequisitesText = (currency) => {
    switch (currency) {
        case 'rub':
            return `–û–ø–ª–∞—Ç–∞ –≤ —Ä—É–±–ª—è—Ö:\n–ö–∞—Ä—Ç–∞: ${CARD_NUMBER_RUB}\n–ë–∞–Ω–∫: –°–±–µ—Ä–±–∞–Ω–∫\n–ü–æ–ª—É—á–∞—Ç–µ–ª—å: –î–∂—É–ª—å–µ—Ç—Ç–∞ –§.\n\n–¶–µ–Ω–∞: 7500 —Ä—É–±.`;
        case 'eur':
            return `–û–ø–ª–∞—Ç–∞ –≤ –µ–≤—Ä–æ:\nBIC: PESOBEB1\nIBAN: ${IBAN_EUR}\n–ë–∞–Ω–∫: N26\n–ü–æ–ª—É—á–∞—Ç–µ–ª—å: Danylo K.\n\n–¶–µ–Ω–∞: 75 EUR`;
        case 'uah':
            return `–û–ø–ª–∞—Ç–∞ –≤ –≥—Ä–∏–≤–Ω–∞—Ö:\n–ö–∞—Ä—Ç–∞: ${CARD_NUMBER_UAH}\n–ë–∞–Ω–∫: –ü—Ä–∏–≤–∞—Ç–ë–∞–Ω–∫\n–ü–æ–ª—É—á–∞—Ç–µ–ª—å: –ó–∞–≤—ñ—Ä—é—Ö–∞ –ê.\n\n–¶–µ–Ω–∞: 3500 UAH`;
        default:
            return '–†–µ–∫–≤–∏–∑–∏—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.';
    }
};

bot.action(/^(express|author)_pay_(rub|eur|uah)$/, (ctx) => {
    const [_, coursePrefix, currency] = ctx.match;
    const requisitesText = createRequisitesText(currency);
    
    let adminId, adminName, copyButtonText;

    if (currency === 'rub') {
        adminId = ADMIN_ID_RADMILA;
        adminName = ADMIN_NAME_RADMILA;
        copyButtonText = COPY_BUTTON_RUB;
    } else if (currency === 'eur') {
        adminId = ADMIN_ID_DANYLO;
        adminName = ADMIN_NAME_DANYLO;
        copyButtonText = COPY_BUTTON_EUR;
    } else { // uah
        adminId = ADMIN_ID_ANASTASIA;
        adminName = ADMIN_NAME_ANASTASIA;
        copyButtonText = COPY_BUTTON_UAH;
    }

    handlePayment(ctx, coursePrefix, requisitesText, copyButtonText, adminId, adminName);
});


// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ "–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å"
bot.action(/copy_(rub|eur|uah)/, (ctx) => {
    const currency = ctx.match[1];
    let textToCopy = '';

    // –õ–æ–≥–∏–∫–∞ —Å—Ç–∞–ª–∞ –Ω–∞–º–Ω–æ–≥–æ –ø—Ä–æ—â–µ –∏ –Ω–∞–¥–µ–∂–Ω–µ–µ
    if (currency === 'rub') textToCopy = CARD_NUMBER_RUB;
    if (currency === 'eur') textToCopy = IBAN_EUR;
    if (currency === 'uah') textToCopy = CARD_NUMBER_UAH;

    if (textToCopy) {
        ctx.reply(`<code>${textToCopy}</code>`, { parse_mode: 'HTML' });
        ctx.answerCbQuery('–ù–æ–º–µ—Ä —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!');
    } else {
        ctx.answerCbQuery('–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å –Ω–æ–º–µ—Ä –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è.');
    }
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ñ–æ—Ç–æ (—Å–∫—Ä–∏–Ω—à–æ—Ç–∞ –æ–ø–ª–∞—Ç—ã)
bot.on('photo', async (ctx) => {
    const userId = ctx.from.id;
    const expectation = paymentExpectations.get(userId);

    if (expectation) {
        const { adminId, course } = expectation;
        const courseName = course === 'express' ? '–≠–∫—Å–ø—Ä–µ—Å—Å –∫—É—Ä—Å' : '–ê–≤—Ç–æ—Ä—Å–∫–∏–π –∫—É—Ä—Å';
        const user = ctx.from;
        const caption = `
–ù–æ–≤—ã–π —Å–∫—Ä–∏–Ω—à–æ—Ç –æ–ø–ª–∞—Ç—ã!

–ö—É—Ä—Å: **${courseName}**
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${user.first_name} ${user.last_name || ''}
Username: @${user.username || '–Ω–µ —É–∫–∞–∑–∞–Ω'}
User ID: ${user.id}
        `;

        await bot.telegram.sendPhoto(adminId, ctx.message.photo[ctx.message.photo.length - 1].file_id, { 
            caption: caption,
            parse_mode: 'Markdown' 
        });

        await ctx.reply("–ú—ã –ø–æ–ª—É—á–∏–ª–∏ —Ñ–æ—Ç–æ, –ø—Ä–æ–≤–µ—Ä–∏–º –µ–≥–æ –∏ —Å—Ä–∞–∑—É –∂–µ –æ—Ç–ø—Ä–∞–≤–∏–º –í–∞–º —Å—Å—ã–ª–∫—É –Ω–∞ –∫—É—Ä—Å.");
        paymentExpectations.delete(userId);
    }
});

// --- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Webhook –∏ –∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞ ---
app.use(express.json());

bot.telegram.setWebhook(`${WEBHOOK_URL}/bot${BOT_TOKEN}`)
    .then(() => console.log('Webhook —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!'))
    .catch(console.error);

app.post(`/bot${BOT_TOKEN}`, (req, res) => {
    bot.handleUpdate(req.body, res);
});

app.get('/', (req, res) => {
    res.send('–ü—Ä–∏–≤–µ—Ç! –ë–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç.');
});

app.listen(PORT, () => {
    console.log(`–°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É ${PORT}`);
});

bot.catch((err, ctx) => {
    console.error(`–û—à–∏–±–∫–∞ –¥–ª—è ${ctx.updateType}`, err);
});
